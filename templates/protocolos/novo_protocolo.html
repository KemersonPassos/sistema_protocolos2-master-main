{% extends 'protocolos/base.html' %}

{% block title %}Novo Protocolo - Sistema de Protocolos{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Abrir Novo Protocolo</h1>

    <div class="card">
        <div class="card-body">
            <!-- Exibição do próximo número do protocolo -->
            <div class="alert alert-info mb-4">
                <strong>Número do Protocolo:</strong> #{{ proximo_numero }}
                <small class="text-muted">(será gerado automaticamente)</small>
            </div>

            <form method="post" id="protocoloForm">
                {% csrf_token %}
                
                <!-- Campo Clientes com busca -->
                <div class="mb-3">
                    <label for="id_clientes" class="form-label">
                        <strong>Clientes</strong>
                        <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        {{ form.clientes }}
                        <button type="button" class="btn btn-success" id="btnAdicionarCliente" data-bs-toggle="modal" data-bs-target="#modalAdicionarCliente">
                            <i class="bi bi-plus-lg"></i> Adicionar Cliente
                        </button>
                    </div>
                    {% if form.clientes.help_text %}
                        <small class="form-text text-muted">{{ form.clientes.help_text }}</small>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_buic_dispositivo" class="form-label">
                        <strong>BUIC do Dispositivo</strong>
                        <span class="text-danger">*</span>
                    </label>
                    {{ form.buic_dispositivo }}
                </div>

                <!-- Campo Tipo de Problema -->
                <div class="mb-3">
                    <label for="id_tipo_problema" class="form-label">
                        <strong>Tipo de Problema</strong>
                        <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        {{ form.tipo_problema }}
                        {% if pode_adicionar_tipo %}
                        <button type="button" class="btn btn-warning" id="btnAdicionarTipoProblema" data-bs-toggle="modal" data-bs-target="#modalAdicionarTipoProblema">
                            <i class="bi bi-plus-lg"></i> Adicionar Tipo
                        </button>
                        {% endif %}
                    </div>
                    {% if form.tipo_problema.help_text %}
                        <small class="form-text text-muted">{{ form.tipo_problema.help_text }}</small>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_descricao_problema" class="form-label">
                        <strong>Descrição do Problema</strong>
                        <span class="text-danger">*</span>
                    </label>
                    {{ form.descricao_problema }}
                </div>

                <div class="mb-3">
                    <label for="primeira_atualizacao" class="form-label">Primeira Atualização (Opcional)</label>
                    <textarea name="primeira_atualizacao" id="primeira_atualizacao" class="form-control" rows="4" placeholder="Adicione a primeira atualização aqui (opcional)"></textarea>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary me-md-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Criar Protocolo #{{ proximo_numero }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Cliente -->
<div class="modal fade" id="modalAdicionarCliente" tabindex="-1" aria-labelledby="modalAdicionarClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAdicionarClienteLabel">Adicionar Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAdicionarCliente">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nomeCliente" class="form-label">Nome do Cliente <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nomeCliente" name="nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailCliente" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="emailCliente" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="senhaCliente" class="form-label">Senha <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="senhaCliente" name="senha" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="salvarCliente">Salvar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Tipo de Problema (apenas para superusuários) -->
{% if pode_adicionar_tipo %}
<div class="modal fade" id="modalAdicionarTipoProblema" tabindex="-1" aria-labelledby="modalAdicionarTipoProblemaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAdicionarTipoProblemaLabel">Adicionar Novo Tipo de Problema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Atenção:</strong> Esta funcionalidade está disponível apenas para superusuários.
                </div>
                <form id="formAdicionarTipoProblema">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nomeTipoProblema" class="form-label">Nome do Tipo de Problema <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nomeTipoProblema" name="nome" required placeholder="Ex: Problema de conectividade">
                    </div>
                    <div class="mb-3">
                        <label for="descricaoTipoProblema" class="form-label">Descrição (Opcional)</label>
                        <textarea class="form-control" id="descricaoTipoProblema" name="descricao" rows="3" placeholder="Descrição detalhada do tipo de problema"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="salvarTipoProblema">Salvar Tipo de Problema</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- CSS e JavaScript -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Estilização para Select2 */
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        min-height: 38px;
        padding: 2px 5px;
    }
    
    .select2-container--default .select2-selection--multiple:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .select2-container {
        width: 100% !important;
    }
    
    .input-group .select2-container {
        flex: 1 1 auto;
    }
    
    .select2-search__field {
        font-size: 1rem;
        padding: 4px 6px;
    }
    
    .alert-success {
        margin-top: 10px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Select2 para o campo de clientes
    $('.select2-clientes').select2({
        placeholder: 'Digite o nome do cliente para buscar...',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return "Nenhum cliente encontrado";
            },
            searching: function() {
                return "Buscando...";
            },
            inputTooShort: function() {
                return "Digite pelo menos 1 caractere para buscar";
            }
        }
    });

    // Função para adicionar novo cliente
    document.getElementById('salvarCliente').addEventListener('click', function() {
        const form = document.getElementById('formAdicionarCliente');
        const formData = new FormData(form);
        
        // Verificar se os campos obrigatórios estão preenchidos
        const nome = document.getElementById('nomeCliente').value.trim();
        const email = document.getElementById('emailCliente').value.trim();
        const senha = document.getElementById('senhaCliente').value.trim();
        
        if (!nome || !email || !senha) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        // Requisição AJAX para adicionar cliente
        fetch('/adicionar_cliente/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Adicionar o novo cliente ao select
                const select = document.getElementById('id_clientes');
                const option = new Option(data.cliente.nome, data.cliente.id, true, true);
                $(select).append(option).trigger('change');
                
                // Fechar modal e limpar formulário
                $('#modalAdicionarCliente').modal('hide');
                form.reset();
                
                // Mostrar mensagem de sucesso
                showAlert('Cliente adicionado com sucesso!', 'success');
            } else {
                showAlert('Erro ao adicionar cliente: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showAlert('Erro ao adicionar cliente. Tente novamente.', 'danger');
        });
    });

    // Função para adicionar novo tipo de problema (apenas superusuários)
    {% if pode_adicionar_tipo %}
    document.getElementById('salvarTipoProblema').addEventListener('click', function() {
        const form = document.getElementById('formAdicionarTipoProblema');
        const formData = new FormData(form);
        
        // Verificar se o campo obrigatório está preenchido
        const nome = document.getElementById('nomeTipoProblema').value.trim();
        
        if (!nome) {
            alert('Por favor, preencha o nome do tipo de problema.');
            return;
        }
        
        // Requisição AJAX para adicionar tipo de problema
        fetch('/adicionar_tipo_problema/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Adicionar o novo tipo de problema ao select
                const select = document.getElementById('id_tipo_problema');
                const option = new Option(data.tipo_problema.nome, data.tipo_problema.id, true, true);
                select.appendChild(option);
                select.value = data.tipo_problema.id;
                
                // Fechar modal e limpar formulário
                $('#modalAdicionarTipoProblema').modal('hide');
                form.reset();
                
                // Mostrar mensagem de sucesso
                showAlert('Tipo de problema adicionado com sucesso!', 'success');
            } else {
                showAlert('Erro ao adicionar tipo de problema: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showAlert('Erro ao adicionar tipo de problema. Tente novamente.', 'danger');
        });
    });
    {% endif %}
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Remover automaticamente após 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}